{% extends "base.html" %}

{% block title %}Configuration - UPS Power Management Server{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2><i class="fas fa-cog me-2"></i>System Configuration</h2>
    </div>
</div>

<form method="POST" action="{{ url_for('save_main_config') }}">
    <div class="config-section">
        <h4 class="section-title"><i class="fas fa-sliders-h me-2"></i>Main Configuration</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="sentinel_hosts" class="form-label">Sentinel Hosts (IP addresses separated by spaces)</label>
                <textarea class="form-control" id="sentinel_hosts" name="sentinel_hosts" rows="3" placeholder="192.168.1.11 192.168.1.12 192.168.1.13">{{ pm_config.get('SENTINEL_HOSTS', '') }}</textarea>
                <div class="form-text">List of IP addresses of devices connected to grid power (not UPS) used to monitor power availability.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="wol_delay_minutes" class="form-label">Wake-on-LAN Delay (minutes)</label>
                <input type="number" class="form-control" id="wol_delay_minutes" name="wol_delay_minutes" min="1" max="60" value="{{ pm_config.get('WOL_DELAY_MINUTES', '5') }}">
                <div class="form-text">Time to wait after power restoration before sending Wake-on-LAN signals.</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="default_broadcast_ip" class="form-label">Default Broadcast Address</label>
                <input type="text" class="form-control" id="default_broadcast_ip" name="default_broadcast_ip" placeholder="192.168.1.255" value="{{ pm_config.get('DEFAULT_BROADCAST_IP', '192.168.1.255') }}">
                <div class="form-text">Broadcast address used for sending Wake-on-LAN packets.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="ups_state_file" class="form-label">UPS State File</label>
                <input type="text" class="form-control" id="ups_state_file" name="ups_state_file" value="{{ pm_config.get('UPS_STATE_FILE', '/var/run/nut/virtual.device') }}" readonly>
                <div class="form-text">Path to the virtual UPS device state file (read-only).</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="power_simulation_mode" name="power_simulation_mode" value="true" {% if pm_config.get('POWER_SIMULATION_MODE') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="power_simulation_mode">Enable Power Outage Simulation</label>
                </div>
                <div class="form-text">Forces the UPS status to "On Battery, Low Battery" to test client shutdown procedures.</div>
            </div>
        </div>
    </div>

    <div class="config-section">
        <h4 class="section-title"><i class="fas fa-envelope me-2"></i>Email Notifications (SMTP)</h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="smtp_server" class="form-label">SMTP Server Address</label>
                <input type="text" class="form-control" id="smtp_server" name="smtp_server" placeholder="smtp.example.com" value="{{ pm_config.get('SMTP_SERVER', '') }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="smtp_port" class="form-label">SMTP Port</label>
                <input type="number" class="form-control" id="smtp_port" name="smtp_port" placeholder="587" value="{{ pm_config.get('SMTP_PORT', '') }}">
                <div class="form-text">Common ports: 25, 26, 465 (SSL), 587 (TLS).</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="smtp_user" class="form-label">Username (optional)</label>
                <input type="text" class="form-control" id="smtp_user" name="smtp_user" placeholder="user@example.com" value="{{ pm_config.get('SMTP_USER', '') }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="smtp_password" class="form-label">Password (optional)</label>
                <input type="password" class="form-control" id="smtp_password" name="smtp_password" value="{{ pm_config.get('SMTP_PASSWORD', '') }}">
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="smtp_sender_name" class="form-label">Sender Name</label>
                <input type="text" class="form-control" id="smtp_sender_name" name="smtp_sender_name" placeholder="UPS Server" value="{{ pm_config.get('SMTP_SENDER_NAME', '') }}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="smtp_sender_email" class="form-label">Sender Email</label>
                <input type="email" class="form-control" id="smtp_sender_email" name="smtp_sender_email" placeholder="ups@example.com" value="{{ pm_config.get('SMTP_SENDER_EMAIL', '') }}">
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-3">
                <label for="smtp_recipients" class="form-label">Recipients</label>
                <input type="text" class="form-control" id="smtp_recipients" name="smtp_recipients" placeholder="admin1@example.com,admin2@example.com" value="{{ pm_config.get('SMTP_RECIPIENTS', '') }}">
                <div class="form-text">Comma-separated list of email addresses.</div>
            </div>
        </div>
    </div>
    
    <div class="config-section">
        <h4 class="section-title"><i class="fas fa-bell me-2"></i>Notification Settings</h4>
        <p class="text-muted">Select which events should trigger an email notification.</p>
        <div class="row">
            <div class="col-md-4">
                <h5><i class="fas fa-bolt text-warning"></i> Power Events</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_power_fail" name="notify_power_fail" value="true" {% if pm_config.get('NOTIFY_POWER_FAIL') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_power_fail">Power Outage Detected</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_power_restored" name="notify_power_restored" value="true" {% if pm_config.get('NOTIFY_POWER_RESTORED') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_power_restored">Power Restored</label>
                </div>
            </div>
            <div class="col-md-4">
                <h5><i class="fas fa-desktop text-primary"></i> UPS Client Events</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_client_shutdown" name="notify_client_shutdown" value="true" {% if pm_config.get('NOTIFY_CLIENT_SHUTDOWN') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_client_shutdown">Client Initiates Shutdown</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_client_stale" name="notify_client_stale" value="true" {% if pm_config.get('NOTIFY_CLIENT_STALE') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_client_stale">Client Status becomes Stale</label>
                </div>
            </div>
            <div class="col-md-4">
                <h5><i class="fas fa-cogs text-info"></i> System Events</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_app_error" name="notify_app_error" value="true" {% if pm_config.get('NOTIFY_APP_ERROR') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_app_error">Application Error</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notify_simulation_mode" name="notify_simulation_mode" value="true" {% if pm_config.get('NOTIFY_SIMULATION_MODE') == 'true' %}checked{% endif %}>
                    <label class="form-check-label" for="notify_simulation_mode">Simulation Mode Changed</label>
                </div>
            </div>
        </div>
    </div>

    <div class="mb-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save me-1"></i> Save Configuration
        </button>
</form>

<form method="POST" action="{{ url_for('test_smtp') }}" class="d-inline-block ms-2">
    <button type="submit" class="btn btn-secondary btn-lg">
        <i class="fas fa-paper-plane me-1"></i> Send Test Email
    </button>
</form>
</div>


<div class="config-section">
    <h4 class="section-title">
        <i class="fas fa-server me-2"></i>Managed Hosts
        <button type="button" class="btn btn-success btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addWakeHostModal">
            <i class="fas fa-plus"></i> Add Host
        </button>
    </h4>

    {% if wake_hosts %}
        <div class="table-responsive d-none d-lg-block">
            <table class="table table-hover mobile-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>IP Address</th>
                        <th>MAC Address</th>
                        <th>Broadcast IP</th>
                        <th>UPS Delay</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section, host in wake_hosts.items() %}
                    <tr>
                        <td><strong>{{ host.get('NAME', section) }}</strong></td>
                        <td><code>{{ host.get('IP', '') }}</code></td>
                        <td><code>{{ host.get('MAC', '') }}</code></td>
                        <td><code>{{ host.get('BROADCAST_IP', pm_config.get('DEFAULT_BROADCAST_IP', '')) }}</code></td>
                        <td>
                            {% if host.get('SHUTDOWN_DELAY_MINUTES') %}
                                <span class="badge bg-success">{{ host.get('SHUTDOWN_DELAY_MINUTES') }} min</span>
                            {% else %}
                                <span class="badge bg-secondary">None</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm me-1" onclick="editWakeHost('{{ section }}', '{{ host.get('NAME', '') }}', '{{ host.get('IP', '') }}', '{{ host.get('MAC', '') }}', '{{ host.get('BROADCAST_IP', '') }}', '{{ host.get('SHUTDOWN_DELAY_MINUTES', '') }}', '{{ host.get('AUTO_WOL', 'true') }}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="POST" action="{{ url_for('delete_wake_host', section=section) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete host {{ host.get('NAME', section) }}?')">
                                <button type="submit" class="btn btn-danger btn-sm" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="mobile-cards d-block d-lg-none">
            {% for section, host in wake_hosts.items() %}
            <div class="mobile-card">
                <div class="mobile-card-header">{{ host.get('NAME', section) }}</div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">IP Address:</span>
                    <span class="mobile-card-value"><code>{{ host.get('IP', '') }}</code></span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">MAC Address:</span>
                    <span class="mobile-card-value"><code>{{ host.get('MAC', '') }}</code></span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">Broadcast IP:</span>
                    <span class="mobile-card-value"><code>{{ host.get('BROADCAST_IP', pm_config.get('DEFAULT_BROADCAST_IP', '')) }}</code></span>
                </div>
                <div class="mobile-card-row">
                    <span class="mobile-card-label">UPS Delay:</span>
                    <span class="mobile-card-value">
                        {% if host.get('SHUTDOWN_DELAY_MINUTES') %}
                            <span class="badge bg-success">{{ host.get('SHUTDOWN_DELAY_MINUTES') }} min</span>
                        {% else %}
                            <span class="badge bg-secondary">None</span>
                        {% endif %}
                    </span>
                </div>
                <div class="mobile-card-actions">
                    <button type="button" class="btn btn-warning btn-sm me-2" onclick="editWakeHost('{{ section }}', '{{ host.get('NAME', '') }}', '{{ host.get('IP', '') }}', '{{ host.get('MAC', '') }}', '{{ host.get('BROADCAST_IP', '') }}', '{{ host.get('SHUTDOWN_DELAY_MINUTES', '') }}', '{{ host.get('AUTO_WOL', 'true') }}')" title="Edit">
                        <i class="fas fa-edit me-1"></i> Edit
                    </button>
                    <form method="POST" action="{{ url_for('delete_wake_host', section=section) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete host {{ host.get('NAME', section) }}?')">
                        <button type="submit" class="btn btn-danger btn-sm" title="Delete">
                            <i class="fas fa-trash me-1"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-server fa-3x mb-3"></i>
            <h5>No hosts configured</h5>
            <p>Add hosts to be automatically awakened after power restoration.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWakeHostModal">
                <i class="fas fa-plus me-1"></i>Add First Host
            </button>
        </div>
    {% endif %}
</div>

<div class="config-section">
    <h4 class="section-title">
        <i class="fas fa-calendar-alt me-2"></i>Power Outage Simulation Scheduler
        <button type="button" class="btn btn-success btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
            <i class="fas fa-plus"></i> Add Schedule
        </button>
    </h4>
    {% if schedules %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Day/Date</th>
                        <th>Time</th>
                        <th>Action</th>
                        <th>Enabled</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section, schedule in schedules.items() %}
                    <tr>
                        <td><strong>{{ schedule.get('NAME', section) }}</strong></td>
                        <td>{{ schedule.get('TYPE', 'One-time') | capitalize }}</td>
                        <td>
                            {% if schedule.get('TYPE') == 'recurring' %}
                                {{ schedule.get('DAY_OF_WEEK') | capitalize }}
                            {% else %}
                                {{ schedule.get('DATE') }}
                            {% endif %}
                        </td>
                        <td><code>{{ schedule.get('TIME') }}</code></td>
                        <td>
                            {% if schedule.get('ACTION') == 'start' %}
                                <span class="badge bg-danger">Start Simulation</span>
                            {% else %}
                                <span class="badge bg-success">Stop Simulation</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.get('ENABLED') == 'true' %}
                                <span class="badge bg-success">Yes</span>
                            {% else %}
                                <span class="badge bg-secondary">No</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm me-1" onclick="editSchedule('{{ section }}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="POST" action="{{ url_for('delete_schedule', section=section) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete schedule {{ schedule.get('NAME', section) }}?')">
                                <button type="submit" class="btn btn-danger btn-sm" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-calendar-times fa-3x mb-3"></i>
            <h5>No schedules configured</h5>
            <p>Add schedules to automatically start or stop the power outage simulation.</p>
        </div>
    {% endif %}
</div>


<div class="modal fade" id="addWakeHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_wake_host') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_name" class="form-label">Host Name</label>
                        <input type="text" class="form-control" id="add_name" name="name" required>
                        <div class="form-text">Descriptive name for the host (e.g., "File Server", "Synology NAS").</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_ip" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="add_ip" name="ip" placeholder="192.168.1.100" required>
                        <div class="form-text">IP address of the host on the local network.</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_mac" class="form-label">MAC Address</label>
                        <input type="text" class="form-control" id="add_mac" name="mac" placeholder="00:11:32:aa:bb:cc" required>
                        <div class="form-text">MAC address of the host's network card (format: XX:XX:XX:XX:XX:XX).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_broadcast_ip" class="form-label">Broadcast IP (optional)</label>
                        <input type="text" class="form-control" id="add_broadcast_ip" name="broadcast_ip" placeholder="192.168.1.255">
                        <div class="form-text">Broadcast address for this host (leave empty to use default).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_shutdown_delay" class="form-label">UPS Shutdown Delay (minutes, optional)</label>
                        <input type="number" class="form-control" id="add_shutdown_delay" name="shutdown_delay" min="1" max="60" placeholder="5">
                        <div class="form-text">If set, host will be a UPS client with specified shutdown delay.</div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="add_auto_wol" name="auto_wol" value="true" checked>
                        <label class="form-check-label" for="add_auto_wol">Enable Automatic Wake-on-LAN</label>
                        <div class="form-text">If enabled, the server will be automatically started after power restoration.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Host</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editWakeHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editWakeHostForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Host Name</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_ip" class="form-label">IP Address</label>
                        <input type="text" class="form-control" id="edit_ip" name="ip" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_mac" class="form-label">MAC Address</label>
                        <input type="text" class="form-control" id="edit_mac" name="mac" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_broadcast_ip" class="form-label">Broadcast IP (optional)</label>
                        <input type="text" class="form-control" id="edit_broadcast_ip" name="broadcast_ip">
                    </div>
                    <div class="mb-3">
                        <label for="edit_shutdown_delay" class="form-label">UPS Shutdown Delay (minutes, optional)</label>
                        <input type="number" class="form-control" id="edit_shutdown_delay" name="shutdown_delay" min="1" max="60">
                        <div class="form-text">If set, host will be a UPS client with specified shutdown delay.</div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="edit_auto_wol" name="auto_wol" value="true">
                        <label class="form-check-label" for="edit_auto_wol">Enable Automatic Wake-on-LAN</label>
                        <div class="form-text">If enabled, the server will be automatically started after power restoration.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="scheduleForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalTitle">Add New Schedule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_section" name="section">
                    <div class="mb-3">
                        <label for="schedule_name" class="form-label">Schedule Name</label>
                        <input type="text" class="form-control" id="schedule_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="schedule_type" class="form-label">Type</label>
                        <select class="form-select" id="schedule_type" name="type">
                            <option value="one-time">One-time</option>
                            <option value="recurring">Recurring</option>
                        </select>
                    </div>
                    <div id="one-time-fields">
                        <div class="mb-3">
                            <label for="schedule_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="schedule_date" name="date">
                        </div>
                    </div>
                    <div id="recurring-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="schedule_day" class="form-label">Day of the Week</label>
                            <select class="form-select" id="schedule_day" name="day_of_week">
                                <option value="monday">Monday</option>
                                <option value="tuesday">Tuesday</option>
                                <option value="wednesday">Wednesday</option>
                                <option value="thursday">Thursday</option>
                                <option value="friday">Friday</option>
                                <option value="saturday">Saturday</option>
                                <option value="sunday">Sunday</option>
                                <option value="everyday">Everyday</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="schedule_time" class="form-label">Time</label>
                        <input type="time" class="form-control" id="schedule_time" name="time" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Action</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" id="action_start" value="start" checked>
                            <label class="form-check-label" for="action_start">Start Simulation</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="action" id="action_stop" value="stop">
                            <label class="form-check-label" for="action_stop">Stop Simulation</label>
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="schedule_enabled" name="enabled" value="true" checked>
                        <label class="form-check-label" for="schedule_enabled">Enabled</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveScheduleBtn">Add Schedule</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Scripts for Wake Host Management
function editWakeHost(section, name, ip, mac, broadcastIp, shutdownDelay, autoWol) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_ip').value = ip;
    document.getElementById('edit_mac').value = mac;
    document.getElementById('edit_broadcast_ip').value = broadcastIp;
    document.getElementById('edit_shutdown_delay').value = shutdownDelay;
    document.getElementById('edit_auto_wol').checked = (autoWol === 'true');
    document.getElementById('editWakeHostForm').action = '/edit_wake_host/' + section;
    new bootstrap.Modal(document.getElementById('editWakeHostModal')).show();
}

document.getElementById('add_mac').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
    let formattedValue = value.match(/.{1,2}/g)?.join(':') || '';
    if (formattedValue.length > 17) formattedValue = formattedValue.substring(0, 17);
    e.target.value = formattedValue.toUpperCase();
});

document.getElementById('edit_mac').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
    let formattedValue = value.match(/.{1,2}/g)?.join(':') || '';
    if (formattedValue.length > 17) formattedValue = formattedValue.substring(0, 17);
    e.target.value = formattedValue.toUpperCase();
});

function formatIP(input) {
    input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9.]/g, '');
        let parts = value.split('.');
        if (parts.length > 4) {
            parts = parts.slice(0, 4);
        }
        parts = parts.map(part => {
            if (parseInt(part) > 255) return '255';
            return part;
        });
        e.target.value = parts.join('.');
    });
}

formatIP(document.getElementById('add_ip'));
formatIP(document.getElementById('add_broadcast_ip'));
formatIP(document.getElementById('edit_ip'));
formatIP(document.getElementById('edit_broadcast_ip'));

document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const ipInputs = form.querySelectorAll('input[name="ip"], input[name="broadcast_ip"], input[name="default_broadcast_ip"]');
            
            ipInputs.forEach(input => {
                if (input.value && !isValidIP(input.value)) {
                    e.preventDefault();
                    input.classList.add('is-invalid');
                    showError('Invalid IP address: ' + input.value);
                    return false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            const macInputs = form.querySelectorAll('input[name="mac"]');
            macInputs.forEach(input => {
                if (input.value && !isValidMAC(input.value)) {
                    e.preventDefault();
                    input.classList.add('is-invalid');
                    showError('Invalid MAC address: ' + input.value);
                    return false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
        });
    });
});

function isValidIP(ip) {
    const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return regex.test(ip);
}

function isValidMAC(mac) {
    const regex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/i;
    return regex.test(mac);
}

function showError(message) {
    const alertContainer = document.querySelector('.container');
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.insertBefore(alert, alertContainer.firstChild);
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    }, 5000);
}

// New scripts for Schedule Management
const addScheduleModalBtn = document.querySelector('[data-bs-target="#addScheduleModal"]');
if (addScheduleModalBtn) {
    addScheduleModalBtn.addEventListener('click', () => {
        const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
        const scheduleForm = document.getElementById('scheduleForm');
        scheduleForm.reset();
        scheduleForm.action = "{{ url_for('add_schedule') }}";
        document.getElementById('scheduleModalTitle').innerText = 'Add New Schedule';
        const saveScheduleBtn = document.getElementById('saveScheduleBtn');
        saveScheduleBtn.innerText = 'Add Schedule';
        saveScheduleBtn.className = 'btn btn-success';
        document.getElementById('schedule_type').dispatchEvent(new Event('change'));
        scheduleModal.show();
    });
}


const allSchedules = {{ schedules|tojson|safe }};

function editSchedule(section) {
    const schedule = allSchedules[section];
    if (!schedule) return;
    
    const scheduleModal = new bootstrap.Modal(document.getElementById('scheduleModal'));
    const scheduleForm = document.getElementById('scheduleForm');
    scheduleForm.reset();
    scheduleForm.action = `/edit_schedule/${section}`;
    document.getElementById('scheduleModalTitle').innerText = 'Edit Schedule';
    const saveScheduleBtn = document.getElementById('saveScheduleBtn');
    saveScheduleBtn.innerText = 'Save Changes';
    saveScheduleBtn.className = 'btn btn-warning';

    document.getElementById('edit_section').value = section;
    document.getElementById('schedule_name').value = schedule.NAME || '';
    document.getElementById('schedule_type').value = schedule.TYPE || 'one-time';
    
    if (schedule.TYPE === 'recurring') {
        document.getElementById('schedule_day').value = schedule.DAY_OF_WEEK || 'monday';
    } else {
        document.getElementById('schedule_date').value = schedule.DATE || '';
    }
    
    document.getElementById('schedule_time').value = schedule.TIME || '';
    
    if (schedule.ACTION === 'stop') {
        document.getElementById('action_stop').checked = true;
    } else {
        document.getElementById('action_start').checked = true;
    }
    
    document.getElementById('schedule_enabled').checked = (schedule.ENABLED === 'true');

    document.getElementById('schedule_type').dispatchEvent(new Event('change'));
    scheduleModal.show();
}

document.getElementById('schedule_type').addEventListener('change', function() {
    if (this.value === 'one-time') {
        document.getElementById('one-time-fields').style.display = 'block';
        document.getElementById('recurring-fields').style.display = 'none';
        document.getElementById('schedule_date').required = true;
        document.getElementById('schedule_day').required = false;
    } else {
        document.getElementById('one-time-fields').style.display = 'none';
        document.getElementById('recurring-fields').style.display = 'block';
        document.getElementById('schedule_date').required = false;
        document.getElementById('schedule_day').required = true;
    }
});

</script>
{% endblock %}