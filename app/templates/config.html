{% extends "base.html" %}

{% block title %}Konfiguracja - UPS Power Management Server{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <h2><i class="fas fa-cog me-2"></i>Konfiguracja Systemu</h2>
    </div>
</div>

<!-- Main Configuration -->
<div class="config-section">
    <h4 class="section-title"><i class="fas fa-sliders-h me-2"></i>Konfiguracja Główna</h4>
    <form method="POST" action="{{ url_for('save_main_config') }}">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="sentinel_hosts" class="form-label">Hosty Sentinel (adresy IP oddzielone spacją)</label>
                <textarea class="form-control" id="sentinel_hosts" name="sentinel_hosts" rows="3" placeholder="192.168.1.11 192.168.1.12 192.168.1.13">{{ pm_config.get('SENTINEL_HOSTS', '') }}</textarea>
                <div class="form-text">Lista adresów IP urządzeń podłączonych do sieci elektrycznej (nie do UPS), które służą do monitorowania dostępności zasilania.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="wol_delay_minutes" class="form-label">Opóźnienie Wake-on-LAN (minuty)</label>
                <input type="number" class="form-control" id="wol_delay_minutes" name="wol_delay_minutes" min="1" max="60" value="{{ pm_config.get('WOL_DELAY_MINUTES', '5') }}">
                <div class="form-text">Czas oczekiwania po przywróceniu zasilania przed wysłaniem sygnałów Wake-on-LAN.</div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="default_broadcast_ip" class="form-label">Domyślny adres broadcast</label>
                <input type="text" class="form-control" id="default_broadcast_ip" name="default_broadcast_ip" placeholder="192.168.1.255" value="{{ pm_config.get('DEFAULT_BROADCAST_IP', '192.168.1.255') }}">
                <div class="form-text">Adres broadcast używany do wysyłania pakietów Wake-on-LAN.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="ups_state_file" class="form-label">Plik stanu UPS</label>
                <input type="text" class="form-control" id="ups_state_file" name="ups_state_file" value="{{ pm_config.get('UPS_STATE_FILE', '/var/run/nut/virtual.device') }}" readonly>
                <div class="form-text">Ścieżka do pliku stanu wirtualnego urządzenia UPS (tylko do odczytu).</div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Zapisz Konfigurację Główną
        </button>
    </form>
</div>

<!-- Wake Hosts Configuration -->
<div class="config-section">
    <h4 class="section-title">
        <i class="fas fa-server me-2"></i>Zarządzane Hosty
        <button type="button" class="btn btn-success btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addWakeHostModal">
            <i class="fas fa-plus"></i> Dodaj Host
        </button>
    </h4>
    
    {% if wake_hosts %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nazwa</th>
                        <th>Adres IP</th>
                        <th>Adres MAC</th>
                        <th>Broadcast IP</th>
                        <th>Opóźnienie UPS</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section, host in wake_hosts.items() %}
                    <tr>
                        <td><strong>{{ host.get('NAME', section) }}</strong></td>
                        <td><code>{{ host.get('IP', '') }}</code></td>
                        <td><code>{{ host.get('MAC', '') }}</code></td>
                        <td><code>{{ host.get('BROADCAST_IP', pm_config.get('DEFAULT_BROADCAST_IP', '')) }}</code></td>
                        <td>
                            {% if host.get('SHUTDOWN_DELAY_MINUTES') %}
                                <span class="badge bg-success">{{ host.get('SHUTDOWN_DELAY_MINUTES') }} min</span>
                            {% else %}
                                <span class="badge bg-secondary">Brak</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-warning btn-sm me-1" onclick="editWakeHost('{{ section }}', '{{ host.get('NAME', '') }}', '{{ host.get('IP', '') }}', '{{ host.get('MAC', '') }}', '{{ host.get('BROADCAST_IP', '') }}', '{{ host.get('SHUTDOWN_DELAY_MINUTES', '') }}')" title="Edytuj">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form method="POST" action="{{ url_for('delete_wake_host', section=section) }}" style="display: inline;" onsubmit="return confirm('Czy na pewno chcesz usunąć host {{ host.get('NAME', section) }}?')">
                                <button type="submit" class="btn btn-danger btn-sm" title="Usuń">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center text-muted py-4">
            <i class="fas fa-server fa-3x mb-3"></i>
            <h5>Brak skonfigurowanych hostów</h5>
            <p>Dodaj hosty, które mają być automatycznie wybudzane po przywróceniu zasilania.</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addWakeHostModal">
                <i class="fas fa-plus me-1"></i>Dodaj Pierwszy Host
            </button>
        </div>
    {% endif %}
</div>

<!-- Add Wake Host Modal -->
<div class="modal fade" id="addWakeHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dodaj Nowy Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_wake_host') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="add_name" class="form-label">Nazwa Hosta</label>
                        <input type="text" class="form-control" id="add_name" name="name" required>
                        <div class="form-text">Opisowa nazwa hosta (np. "Serwer Plików", "NAS Synology").</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_ip" class="form-label">Adres IP</label>
                        <input type="text" class="form-control" id="add_ip" name="ip" placeholder="192.168.1.100" required>
                        <div class="form-text">Adres IP hosta w sieci lokalnej.</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_mac" class="form-label">Adres MAC</label>
                        <input type="text" class="form-control" id="add_mac" name="mac" placeholder="00:11:32:aa:bb:cc" required>
                        <div class="form-text">Adres MAC karty sieciowej hosta (format: XX:XX:XX:XX:XX:XX).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_broadcast_ip" class="form-label">Broadcast IP (opcjonalne)</label>
                        <input type="text" class="form-control" id="add_broadcast_ip" name="broadcast_ip" placeholder="192.168.1.255">
                        <div class="form-text">Adres broadcast dla tego hosta (pozostaw puste, aby użyć domyślnego).</div>
                    </div>
                    <div class="mb-3">
                        <label for="add_shutdown_delay" class="form-label">Opóźnienie wyłączenia UPS (minuty, opcjonalne)</label>
                        <input type="number" class="form-control" id="add_shutdown_delay" name="shutdown_delay" min="1" max="60" placeholder="5">
                        <div class="form-text">Jeśli ustawione, host będzie klientem UPS z określonym opóźnieniem wyłączenia.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-success">Dodaj Host</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Wake Host Modal -->
<div class="modal fade" id="editWakeHostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edytuj Host</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editWakeHostForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">Nazwa Hosta</label>
                        <input type="text" class="form-control" id="edit_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_ip" class="form-label">Adres IP</label>
                        <input type="text" class="form-control" id="edit_ip" name="ip" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_mac" class="form-label">Adres MAC</label>
                        <input type="text" class="form-control" id="edit_mac" name="mac" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_broadcast_ip" class="form-label">Broadcast IP (opcjonalne)</label>
                        <input type="text" class="form-control" id="edit_broadcast_ip" name="broadcast_ip">
                    </div>
                    <div class="mb-3">
                        <label for="edit_shutdown_delay" class="form-label">Opóźnienie wyłączenia UPS (minuty, opcjonalne)</label>
                        <input type="number" class="form-control" id="edit_shutdown_delay" name="shutdown_delay" min="1" max="60">
                        <div class="form-text">Jeśli ustawione, host będzie klientem UPS z określonym opóźnieniem wyłączenia.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="submit" class="btn btn-warning">Zapisz Zmiany</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function editWakeHost(section, name, ip, mac, broadcastIp, shutdownDelay) {
    document.getElementById('edit_name').value = name;
    document.getElementById('edit_ip').value = ip;
    document.getElementById('edit_mac').value = mac;
    document.getElementById('edit_broadcast_ip').value = broadcastIp;
    document.getElementById('edit_shutdown_delay').value = shutdownDelay;
    document.getElementById('editWakeHostForm').action = '/edit_wake_host/' + section;
    new bootstrap.Modal(document.getElementById('editWakeHostModal')).show();
}

// Validate MAC address format
document.getElementById('add_mac').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
    let formattedValue = value.match(/.{1,2}/g)?.join(':') || value;
    if (formattedValue.length > 17) formattedValue = formattedValue.substring(0, 17);
    e.target.value = formattedValue;
});

document.getElementById('edit_mac').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9A-Fa-f]/g, '');
    let formattedValue = value.match(/.{1,2}/g)?.join(':') || value;
    if (formattedValue.length > 17) formattedValue = formattedValue.substring(0, 17);
    e.target.value = formattedValue;
});

// Auto-format IP addresses
function formatIP(input) {
    input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9.]/g, '');
        let parts = value.split('.');
        if (parts.length > 4) {
            parts = parts.slice(0, 4);
        }
        parts = parts.map(part => {
            if (parseInt(part) > 255) return '255';
            return part;
        });
        e.target.value = parts.join('.');
    });
}

formatIP(document.getElementById('add_ip'));
formatIP(document.getElementById('add_broadcast_ip'));
formatIP(document.getElementById('edit_ip'));
formatIP(document.getElementById('edit_broadcast_ip'));

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const ipInputs = form.querySelectorAll('input[type="text"][name$="ip"], input[name="ip"]');
            ipInputs.forEach(input => {
                if (input.value && !isValidIP(input.value)) {
                    e.preventDefault();
                    input.classList.add('is-invalid');
                    showError('Nieprawidłowy adres IP: ' + input.value);
                    return false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            
            const macInputs = form.querySelectorAll('input[name="mac"]');
            macInputs.forEach(input => {
                if (input.value && !isValidMAC(input.value)) {
                    e.preventDefault();
                    input.classList.add('is-invalid');
                    showError('Nieprawidłowy adres MAC: ' + input.value);
                    return false;
                } else {
                    input.classList.remove('is-invalid');
                }
            });
        });
    });
});

function isValidIP(ip) {
    const regex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return regex.test(ip);
}

function isValidMAC(mac) {
    const regex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;
    return regex.test(mac);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
    
    setTimeout(() => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    }, 5000);
}
</script>
{% endblock %}